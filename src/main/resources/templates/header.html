<div th:fragment="header">
    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#e7edf4] px-10 py-3">
        <div class="flex items-center gap-4 text-[#0d141c]">
            <a href="/" aria-label="Ir para a pÃ¡gina inicial"
               class="inline-flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <div class="relative bg-red-600 p-1 rounded overflow-hidden transition-all duration-300 ease-out hover:shadow-lg hover:bg-red-700">
                    <img src="/images/logo.png" alt="Logo"
                         class="h-20 w-auto rounded transition-transform duration-300 ease-out hover:scale-105"/>
                </div>
            </a>
            <h2 class="text-[#0d141c] text-lg font-bold leading-tight tracking-[-0.015em]" th:text="#{app.title}">Portal de Agendamentos</h2>
        </div>
        <div class="flex flex-1 justify-end gap-6 items-center">
            <nav class="flex items-center gap-6">
                <a class="text-[#0d141c] text-sm font-medium leading-normal" href="#" th:text="#{nav.embassies}">Para Embaixadas</a>
                <a class="text-[#0d141c] text-sm font-medium leading-normal" href="#" th:text="#{nav.applicants}">Para Requerentes</a>
                <a class="text-[#0d141c] text-sm font-medium leading-normal" href="#" th:text="#{nav.pricing}">PreÃ§os</a>
                <a class="text-[#0d141c] text-sm font-medium leading-normal" href="#" th:text="#{nav.contact}">Contacto</a>
            </nav>
            <div class="flex items-center gap-3">
                <!-- Language dropdown -->
                <div class="relative" x-data>
                    <button id="langMenuButton" type="button" class="rounded-lg border border-slate-300 px-3 py-2 text-sm inline-flex items-center gap-2"
                            aria-haspopup="true" aria-expanded="false" aria-controls="langMenu">
                        <!-- Languages icon (more suggestive than a globe) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <!-- Lucide Languages icon -->
                            <path d="m5 8 6 6"></path>
                            <path d="m4 14 6-6 2-3"></path>
                            <path d="M2 5h12"></path>
                            <path d="M7 2h1"></path>
                            <path d="M22 22l-5-10-5 10"></path>
                            <path d="M14 18h6"></path>
                        </svg>
                        <span class="sr-only">Idioma</span>
                    </button>
                    <div id="langMenu" class="absolute right-0 mt-2 w-44 rounded-md border border-slate-200 bg-white shadow-lg py-1 hidden z-50">
                        <a href="#" onclick="switchLang('pt'); return false;" class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-slate-100">
                            <span aria-hidden="true">ðŸ‡µðŸ‡¹</span>
                            <span th:text="#{lang.pt}">PortuguÃªs</span>
                        </a>
                        <a href="#" onclick="switchLang('de'); return false;" class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-slate-100">
                            <span aria-hidden="true">ðŸ‡©ðŸ‡ª</span>
                            <span th:text="#{lang.de}">AlemÃ£o</span>
                        </a>
                        <a href="#" onclick="switchLang('en'); return false;" class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-slate-100">
                            <span aria-hidden="true">ðŸ‡¬ðŸ‡§</span>
                            <span th:text="#{lang.en}">English</span>
                        </a>
                    </div>
                </div>
                <button type="button" onclick="toggleTheme()" class="rounded-lg border border-slate-300 px-3 py-2 text-sm"
                        th:attr="aria-label=#{theme.toggle}">ðŸŒ“</button>
                <!-- Visual divider to separate menu/lang/theme from profile -->
                <div class="mx-2 h-6 w-px bg-slate-300" aria-hidden="true"></div>
                <!-- Profile button (always shown) -->
                <!-- Logged-in: show dropdown menu -->
                <div class="relative" th:if="${showUserHeader}">
                    <button id="userMenuButton" type="button" class="relative rounded-full h-10 w-10 bg-red-600 text-white flex items-center justify-center shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                            aria-haspopup="true" aria-expanded="false" aria-controls="userMenu" title="Conta">
                        <!-- User icon (unchanged) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <!-- Subtle status dot indicating logged-in -->
                        <span aria-hidden="true" class="absolute bottom-0 right-0 h-2 w-2 rounded-full bg-emerald-400 border border-white"></span>
                        <span class="sr-only">Menu do utilizador</span>
                    </button>
                    <div id="userMenu" class="absolute right-0 mt-2 w-48 rounded-md border border-slate-200 bg-white shadow-lg py-1 hidden z-50">
                        <a href="/appointments" class="block px-3 py-2 text-sm text-[#0d141c] hover:bg-slate-100">Meus agendamentos</a>
                        <a href="/profile" class="block px-3 py-2 text-sm text-[#0d141c] hover:bg-slate-100">Meu perfil</a>
                        <a href="/auth/logout" class="block px-3 py-2 text-sm text-[#0d141c] hover:bg-slate-100">Sair</a>
                    </div>
                </div>
                <!-- Not logged-in: simple link to login using the same avatar style for simplicity -->
                <div th:if="${showUserHeader} == null or !${showUserHeader}">
                    <a href="/login" class="relative rounded-full h-10 w-10 bg-red-600 text-white flex items-center justify-center shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" title="Iniciar sessÃ£o">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <!-- Subtle neutral dot for not logged-in -->
                        <span aria-hidden="true" class="absolute bottom-0 right-0 h-2 w-2 rounded-full bg-slate-300 border border-white"></span>
                        <span class="sr-only">Ir para login</span>
                    </a>
                </div>
            </div>
        </div>
    </header>
    <script>
      (function(){
        // Language menu handlers
        const langBtn = document.getElementById('langMenuButton');
        const langMenu = document.getElementById('langMenu');
        if (langBtn && langMenu) {
          function closeLang(){ langMenu.classList.add('hidden'); langBtn.setAttribute('aria-expanded','false'); }
          function openLang(){ langMenu.classList.remove('hidden'); langBtn.setAttribute('aria-expanded','true'); }
          langBtn.addEventListener('click', function(e){
            e.stopPropagation();
            if(langMenu.classList.contains('hidden')) openLang(); else closeLang();
          });
          document.addEventListener('click', function(){ closeLang(); });
          document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeLang(); });
        }

        // User menu handlers
        const userBtn = document.getElementById('userMenuButton');
        const userMenu = document.getElementById('userMenu');
        if (userBtn && userMenu) {
          function closeUser(){ userMenu.classList.add('hidden'); userBtn.setAttribute('aria-expanded','false'); }
          function openUser(){ userMenu.classList.remove('hidden'); userBtn.setAttribute('aria-expanded','true'); }
          userBtn.addEventListener('click', function(e){
            e.stopPropagation();
            if(userMenu.classList.contains('hidden')) openUser(); else closeUser();
          });
          document.addEventListener('click', function(){ closeUser(); });
          document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeUser(); });
        }

        // Expose language switcher that preserves the current path and query string
        window.switchLang = function(lang){
          try {
            const url = new URL(window.location.href);
            url.searchParams.set('lang', lang);
            // Optional: keep hash
            window.location.href = url.toString();
          } catch (e) {
            // Fallback
            const sep = window.location.href.includes('?') ? '&' : '?';
            window.location.href = window.location.href + sep + 'lang=' + encodeURIComponent(lang);
          }
        }
      })();
    </script>
</div>
