<html
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      th:lang="${#locale}"
      layout:decorate="~{layout}">

<head>
    <title th:text="#{schedule.datetime.title}">Select Date &amp; Time</title>
</head>
<body>
<section layout:fragment="content">
    <div class="relative flex size-full min-h-screen flex-col bg-slate-50 group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
        <div class="layout-container flex h-full grow flex-col">
            <div class="px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col w-[512px] max-w-[512px] py-5 max-w-[960px] flex-1">
                    <div class="flex flex-wrap gap-2 p-4">
                        <a class="text-[#49739c] text-base font-medium leading-normal" href="/appointments" th:text="#{schedule.breadcrumb.root}">Appointments</a>
                        <span class="text-[#49739c] text-base font-medium leading-normal">/</span>
                        <span class="text-[#0d141c] text-base font-medium leading-normal" th:text="#{schedule.datetime.breadcrumb.current}">Select Date &amp; Time</span>
                    </div>
                    <h2 class="text-[#0d141c] tracking-light text-[28px] font-bold leading-tight px-4 text-left pb-3 pt-5" th:text="#{schedule.datetime.heading}">Select Date &amp; Time</h2>

                    <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                        <span class="block sm:inline" th:text="${error}"></span>
                    </div>

                    <form th:action="@{/schedule-appointment-time}" method="post">
                        <input type="hidden" name="service" th:value="${service}" />
                        <input type="hidden" name="applicantType" th:value="${applicantType}" />
                        <input type="hidden" name="otherFirstName" th:value="${otherFirstName}" />
                        <input type="hidden" name="otherLastName" th:value="${otherLastName}" />
                        <input type="hidden" name="otherEmail" th:value="${otherEmail}" />
                        <input type="hidden" name="otherPhone" th:value="${otherPhone}" />

                        <div class="p-4">
                            <div th:insert="~{appointment-calendar :: appointmentCalendar}"></div>
                            <input type="hidden" id="selected-date" name="date" />
                        </div>

                        <div th:insert="~{appointment-times :: appointmentTimes}"></div>

                        <div class="flex px-4 py-3 justify-between">
                            <a th:href="${applicantType == 'OTHER'} ? @{/schedule-for-other(service=${service})} : @{/schedule-who(service=${service})}"
                               class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#0d80f2] text-slate-50 text-sm font-bold leading-normal tracking-[0.015em]">
                                <span class="truncate" th:text="#{common.back}">Back</span>
                            </a>
                            <button type="submit"
                               class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#0d80f2] text-slate-50 text-sm font-bold leading-normal tracking-[0.015em]">
                                <span class="truncate" th:text="#{schedule.next}">Next</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /* Pass selectedDate from model to JavaScript */
        const initialSelectedDate = /*[[${selectedDate}]]*/ null;
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const monthYearEl = document.getElementById('month-year');
            const calendarGridEl = document.getElementById('calendar-grid');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const selectedDateInput = document.getElementById('selected-date');
            const availableTimesContainer = document.getElementById('available-times-container');

            let currentDate = new Date();
            if (initialSelectedDate) {
                // If a date was passed back from the server, use it to set the initial calendar view
                const parts = initialSelectedDate.split('-');
                currentDate = new Date(parts[0], parts[1] - 1, 1);
                selectedDateInput.value = initialSelectedDate;
            }
            currentDate.setDate(1);
            let availableSlots = {};

            async function fetchAvailableSlots() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                try {
                    const response = await fetch(`/api/appointments/available-slots?year=${year}&month=${month}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    availableSlots = await response.json();
                    renderCalendar();
                    // If a date was pre-selected, render its times immediately
                    if (initialSelectedDate && availableSlots[initialSelectedDate]) {
                        renderAvailableTimes(availableSlots[initialSelectedDate]);
                    }
                } catch (error) {
                    console.error('Failed to fetch available slots:', error);
                    availableSlots = {};
                    renderCalendar();
                }
            }

            function renderCalendar() {
                const month = currentDate.getMonth();
                const year = currentDate.getFullYear();

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                if (year < currentYear || (year === currentYear && month < currentMonth)) {
                    prevMonthBtn.disabled = true;
                    prevMonthBtn.classList.add('cursor-not-allowed', 'opacity-50');
                } else {
                    prevMonthBtn.disabled = false;
                    prevMonthBtn.classList.remove('cursor-not-allowed', 'opacity-50');
                }

                monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
                calendarGridEl.innerHTML = '';

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                dayHeaders.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'font-semibold text-gray-600 text-sm';
                    dayEl.textContent = day;
                    calendarGridEl.appendChild(dayEl);
                });

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyEl = document.createElement('div');
                    calendarGridEl.appendChild(emptyEl);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('button');
                    dayEl.type = 'button';
                    dayEl.textContent = day;
                    dayEl.className = 'p-2 rounded-full';
                    
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const dayDate = new Date(year, month, day);

                    if (dayDate < today || !availableSlots[dateStr]) {
                        dayEl.disabled = true;
                        dayEl.classList.add('text-gray-400', 'cursor-not-allowed');
                    } else {
                        dayEl.classList.add('hover:bg-blue-100', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400');
                        dayEl.addEventListener('click', () => {
                            selectedDateInput.value = dateStr;
                            renderAvailableTimes(availableSlots[dateStr]);

                            document.querySelectorAll('#calendar-grid button').forEach(btn => {
                                btn.classList.remove('bg-blue-500', 'text-white');
                                if(!btn.disabled) {
                                   btn.classList.add('hover:bg-blue-100');
                                }
                            });
                            dayEl.classList.add('bg-blue-500', 'text-white');
                            dayEl.classList.remove('hover:bg-blue-100');
                        });
                    }
                    
                    if (selectedDateInput.value === dateStr) {
                         dayEl.classList.add('bg-blue-500', 'text-white');
                         dayEl.classList.remove('hover:bg-blue-100');
                    }

                    calendarGridEl.appendChild(dayEl);
                }
            }

            function renderAvailableTimes(times) {
                availableTimesContainer.innerHTML = '';
                if (times && times.length > 0) {
                    times.forEach(time => {
                        const label = document.createElement('label');
                        label.className = 'text-sm font-medium leading-normal flex items-center justify-center rounded-lg border border-[#cedbe8] px-4 h-11 text-[#0d141c] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-[#0d80f2] relative cursor-pointer';
                        label.textContent = time;

                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'time';
                        radio.value = time;
                        radio.className = 'invisible absolute';

                        label.appendChild(radio);
                        availableTimesContainer.appendChild(label);
                    });
                } else {
                    availableTimesContainer.textContent = 'No available times for this date.';
                }
            }

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                fetchAvailableSlots();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                fetchAvailableSlots();
            });

            fetchAvailableSlots();
        });
    </script>
</section>
</body>
</html>